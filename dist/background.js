const VERCEL_API_URL="https://www.kitha.co",RAILWAY_API_URL="https://twitteraireporter-production.up.railway.app",FREE_SCAN_LIMIT=50;function log(e,t=null){const a=(new Date).toISOString();t?console.log(`[Kitha BG ${a}] ${e}`,t):console.log(`[Kitha BG ${a}] ${e}`)}async function checkDailyReset(){const e=await chrome.storage.local.get(["lastScanDate","dailyScans"]),t=(new Date).toDateString();return e.lastScanDate!==t?(await chrome.storage.local.set({dailyScans:0,lastScanDate:t}),0):e.dailyScans||0}async function canScan(){if((await chrome.storage.local.get(["apiKey","dailyScans","lastScanDate"])).apiKey)return{allowed:!0,isPro:!0};const e=await checkDailyReset();return e>=50?{allowed:!1,isPro:!1,remaining:0}:{allowed:!0,isPro:!1,remaining:50-e}}async function incrementScanCount(){const e=await chrome.storage.local.get(["dailyScans","tweetsScanned","apiKey"]);e.apiKey?await chrome.storage.local.set({tweetsScanned:(e.tweetsScanned||0)+1}):await chrome.storage.local.set({dailyScans:(e.dailyScans||0)+1,tweetsScanned:(e.tweetsScanned||0)+1})}async function incrementAICount(){const e=await chrome.storage.local.get(["aiDetected"]);await chrome.storage.local.set({aiDetected:(e.aiDetected||0)+1})}async function detectAI(e,t){const a=performance.now(),n=await chrome.storage.local.get(["apiKey"]),o=!!n.apiKey;log(`Starting API call for tweet ${t}`,{textLength:e.length,hasApiKey:o});try{let c;if(o){if(log(`Fetching ${VERCEL_API_URL}/api/detect (authenticated)...`),c=await fetch(`${VERCEL_API_URL}/api/detect`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":n.apiKey},body:JSON.stringify({text:e,tweetId:t})}),401===c.status)return log("API key invalid or expired"),{success:!1,error:"Invalid API key. Please check your key at kitha.co",authError:!0};if(429===c.status)return log("Rate limit exceeded on server"),{success:!1,error:"Rate limit exceeded",limitReached:!0}}else log(`Fetching ${RAILWAY_API_URL}/predict (free tier)...`),c=await fetch(`${RAILWAY_API_URL}/predict`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(log(`Fetch completed in ${(performance.now()-a).toFixed(0)}ms, status: ${c.status}`),!c.ok)throw new Error(`API error: ${c.status}`);const i=await c.json();return log(`API call complete in ${(performance.now()-a).toFixed(0)}ms`,i),{success:!0,aiProb:i.aiProb,humanProb:i.humanProb,isAI:i.aiProb>.5}}catch(e){return log(`API error after ${(performance.now()-a).toFixed(0)}ms: ${e.message}`),{success:!1,error:e.message}}}async function validateApiKey(e){try{const t=await fetch(`${VERCEL_API_URL}/api/user`,{method:"GET",headers:{"X-API-Key":e}});if(t.ok){const e=await t.json();return{valid:!0,user:{email:e.email,subscription:e.subscription}}}return{valid:!1,error:"Invalid API key"}}catch(e){return log("API key validation error:",e),{valid:!1,error:"Could not validate API key"}}}chrome.runtime.onMessage.addListener((e,t,a)=>{if(log(`Received message: ${e.type}`,{tweetId:e.tweetId}),"CHECK_CAN_SCAN"===e.type)return canScan().then(a),!0;if("DETECT_AI"===e.type){const t=performance.now();return log(`Processing DETECT_AI for tweet ${e.tweetId}`),(async()=>{log("Checking scan limits...");const n=await canScan();if(log("Scan check result:",n),!n.allowed)return log("Scan not allowed - limit reached"),void a({success:!1,limitReached:!0,remaining:0});const o=await detectAI(e.text,e.tweetId);o.success&&(log("Incrementing counters..."),await incrementScanCount(),o.isAI&&await incrementAICount());log(`Total message handling time: ${(performance.now()-t).toFixed(0)}ms`),a(o)})(),!0}return"VALIDATE_API_KEY"===e.type?(validateApiKey(e.apiKey).then(a),!0):"INCREMENT_SCAN"===e.type?(incrementScanCount().then(()=>a({success:!0})),!0):"INCREMENT_AI"===e.type?(incrementAICount().then(()=>a({success:!0})),!0):"GET_SETTINGS"===e.type?((async()=>{await checkDailyReset();const e=await chrome.storage.local.get(["apiKey","dailyScans","lastScanDate","tweetsScanned","aiDetected"]);a(e)})(),!0):void 0}),chrome.runtime.onInstalled.addListener(()=>{console.log("[Kitha] Extension installed"),chrome.storage.local.set({tweetsScanned:0,aiDetected:0,dailyScans:0,lastScanDate:(new Date).toDateString()})});