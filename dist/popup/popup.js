const FREE_SCAN_LIMIT=50;async function loadData(){return new Promise(e=>{chrome.runtime.sendMessage({type:"GET_SETTINGS"},t=>{chrome.storage.local.get(["userEmail","userSubscription"],n=>{e({...t,...n})})})})}async function saveApiKey(e,t=null,n=null){return new Promise(i=>{const d={apiKey:e};t&&(d.userEmail=t),n&&(d.userSubscription=n),chrome.storage.local.set(d,i)})}async function removeApiKey(){return new Promise(e=>{chrome.storage.local.remove(["apiKey","userEmail","userSubscription"],e)})}async function validateApiKeyWithServer(e){return new Promise(t=>{chrome.runtime.sendMessage({type:"VALIDATE_API_KEY",apiKey:e},t)})}function getDailyScans(e){return e.dailyScans||0}async function updateUI(){const e=await loadData();document.getElementById("tweetsScanned").textContent=(e.tweetsScanned||0).toLocaleString(),document.getElementById("aiDetected").textContent=(e.aiDetected||0).toLocaleString();const t=getDailyScans(e),n=!!e.apiKey,i=document.getElementById("apiIcon"),d=document.getElementById("apiText"),a=document.getElementById("apiButton"),s=document.getElementById("scanLimitSection"),o=document.getElementById("limitProgress"),c=document.getElementById("limitText");if(n){i.textContent="ðŸ”“";const t="pro"===e.userSubscription?"Pro Plan (Unlimited)":"Logged In";d.textContent=e.userEmail?`${t}`:"Pro Plan (Unlimited)",a.textContent="Remove API Key",a.classList.add("remove"),s.classList.add("hidden"),e.userEmail&&(d.innerHTML=`${t}<br><small style="opacity: 0.7">${e.userEmail}</small>`)}else{i.textContent="ðŸ”’",d.textContent="Free Plan (50 scans/day)",a.textContent="Enter API Key",a.classList.remove("remove"),s.classList.remove("hidden");const e=Math.min(t/50*100,100);o.style.width=`${e}%`,c.textContent=`${t} / 50 scans today`,t>=50?(o.classList.add("limit-reached"),document.getElementById("statusIndicator").classList.remove("active"),document.getElementById("statusIndicator").classList.add("limited"),document.getElementById("statusText").textContent="Daily Limit Reached"):(o.classList.remove("limit-reached"),document.getElementById("statusIndicator").classList.add("active"),document.getElementById("statusIndicator").classList.remove("limited"),document.getElementById("statusText").textContent="Extension Active")}}function toggleApiInput(e){const t=document.getElementById("apiSection"),n=document.getElementById("apiInputSection"),i=document.getElementById("removeConfirmSection");e?(t.classList.add("hidden"),n.classList.remove("hidden"),i.classList.add("hidden"),document.getElementById("apiKeyInput").focus(),document.getElementById("apiError").classList.add("hidden")):(t.classList.remove("hidden"),n.classList.add("hidden"),i.classList.add("hidden"),document.getElementById("apiKeyInput").value="")}function toggleRemoveConfirm(e){const t=document.getElementById("apiSection"),n=document.getElementById("apiInputSection"),i=document.getElementById("removeConfirmSection");e?(t.classList.add("hidden"),n.classList.add("hidden"),i.classList.remove("hidden")):(t.classList.remove("hidden"),n.classList.add("hidden"),i.classList.add("hidden"))}function setLoading(e){const t=document.getElementById("saveApiKey");e?(t.textContent="Validating...",t.disabled=!0):(t.textContent="Save",t.disabled=!1)}function showError(e){const t=document.getElementById("apiError");t.textContent=e,t.classList.remove("hidden")}document.addEventListener("DOMContentLoaded",()=>{updateUI(),setInterval(updateUI,1e3),document.getElementById("apiButton").addEventListener("click",async()=>{(await loadData()).apiKey?toggleRemoveConfirm(!0):toggleApiInput(!0)}),document.getElementById("confirmRemoveKey").addEventListener("click",async()=>{await removeApiKey(),toggleRemoveConfirm(!1),updateUI()}),document.getElementById("cancelRemoveKey").addEventListener("click",()=>{toggleRemoveConfirm(!1)}),document.getElementById("saveApiKey").addEventListener("click",async()=>{const e=document.getElementById("apiKeyInput").value.trim();if(!e||e.length<8)return void showError("Please enter a valid API key (at least 8 characters)");setLoading(!0);const t=await validateApiKeyWithServer(e);setLoading(!1),t.valid?(await saveApiKey(e,t.user?.email,t.user?.subscription),toggleApiInput(!1),updateUI()):showError(t.error||"Invalid API key. Please check and try again.")}),document.getElementById("cancelApiKey").addEventListener("click",()=>{toggleApiInput(!1)}),document.getElementById("apiKeyInput").addEventListener("keypress",e=>{"Enter"===e.key&&document.getElementById("saveApiKey").click()}),document.getElementById("apiKeyInput").addEventListener("input",()=>{document.getElementById("apiError").classList.add("hidden")})});