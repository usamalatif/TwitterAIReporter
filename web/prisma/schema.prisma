generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Supabase pooled connection
  directUrl = env("DIRECT_URL")   // Supabase direct connection for migrations
}

enum SubscriptionTier {
  free
  pro
}

enum SubscriptionStatus {
  active
  canceled
  past_due
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  createdAt         DateTime @default(now())
  subscription      SubscriptionTier @default(free)
  stripeCustomerId  String?
  apiKey            String   @unique @default(uuid())
  apiKeyHash        String?

  usage             Usage[]
  subscriptionData  Subscription?
  betaSignup        BetaSignup?
}

model Usage {
  id          String   @id @default(uuid())
  userId      String
  date        DateTime @db.Date
  scanCount   Int      @default(0)
  aiDetected  Int      @default(0)

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model Subscription {
  id                     String             @id @default(uuid())
  userId                 String             @unique
  stripeSubscriptionId   String             @unique
  status                 SubscriptionStatus @default(active)
  currentPeriodEnd       DateTime

  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MagicLink {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model BetaSignup {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
  userId    String?  @unique

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Promotion {
  id          String   @id @default(uuid())
  code        String   @unique
  description String
  maxUses     Int
  usedCount   Int      @default(0)
  discountPercent Int  @default(100)
  durationMonths  Int  @default(1)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  claims      PromotionClaim[]
}

model PromotionClaim {
  id          String   @id @default(uuid())
  promotionId String
  userId      String   @unique
  claimedAt   DateTime @default(now())

  promotion   Promotion @relation(fields: [promotionId], references: [id])
}

model Feedback {
  id        String   @id @default(uuid())
  email     String
  message   String
  createdAt DateTime @default(now())
}

model ModelFeedback {
  id          String   @id @default(uuid())
  tweetId     String
  tweetText   String
  aiProb      Float
  prediction  String   // "human", "uncertain", "ai"
  isCorrect   Boolean  // true = user confirmed, false = user said wrong
  createdAt   DateTime @default(now())

  @@index([isCorrect])
  @@index([prediction])
}

model AppStats {
  id        String   @id @default("app-stats")
  downloads Int      @default(0)
  updatedAt DateTime @updatedAt
}
